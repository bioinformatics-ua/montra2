{% extends 'base_barebones.html' %}
{% load static %}
{% comment %}
# -*- coding: utf-8 -*-
# Copyright (C) 2014 Universidade de Aveiro, DETI/IEETA, Bioinformatics Group - http://bioinformatics.ua.pt/
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}
{% load extra_tags %}
{% load django_bootstrap_breadcrumbs %}
{% load comments %}
{% load hitcount_tags %}

{% block uncompressed_css %}
<link rel="stylesheet" href="{% static 'css/c3.css' %}">
{% endblock %}


{% block styleinclude %}
<link rel="stylesheet" href="{% static 'css/database_info.css' %}" />
<link rel="stylesheet" href="{% static 'css/vendor/jquery.boolrelwidget.css' %}"></script>

<!-- Generic page styles -->
<link rel="stylesheet" href="{% static 'css/vendor/style.css' %}">
<!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
<link rel="stylesheet" href="{% static 'css/vendor/jquery.fileupload-ui.css' %}">
<!--<link rel="stylesheet" href="{% static 'css/c3.css' %}">-->

<link rel="stylesheet" href="{% static 'css/jquery.dyndropdown.css' %}">
<link rel="stylesheet" href="{% static 'css/pc.css' %}">

<link rel="stylesheet" href="{% static 'css/vendor/bootstrap-tagsinput.css' %}" />
<link rel="stylesheet" href="{% static 'css/dataTables.tableTools.css' %}">

<link rel="stylesheet" href="{% static 'css/dataTables.bootstrap.css' %}">

<style type="text/css">

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.bar {
  fill: steelblue;
}

.x.axis path {
  display: none;
}

#pctitle{
    text-align: center;
}
#pc_chart_place{
    /*margin-left: 60px;*/
}
#jerboaupload{
    margin-left: 60px;
    margin-top: 30px;

}
.progress .progressbar-back-text {
    font-weight: bold;
}

</style>
{% endblock %}

{% block headextra %}
<script src="{% static 'js/vendor/FileSaver.js' %}"></script>
<script src="{% static 'js/vendor/rgbcolor.js' %}"></script>
<script src="{% static 'js/vendor/StackBlur.js' %}"></script>
<script src="{% static 'js/vendor/canvg.js' %}"></script>
<script src="{% static 'js/vendor/jspdf.js' %}"></script>
<script src="{% static 'js/vendor/jspdf.plugin.addimage.js' %}"></script>
<script src="{% static 'js/vendor/zlib.js' %}"></script>
<script src="{% static 'js/vendor/png.js' %}"></script>
<script src="{% static 'js/vendor/jspdf.plugin.png_support.js' %}"></script>
<script src="{% static 'js/vendor/taskqueuer.js' %}"></script>
<script src="{% static 'js/vendor/jquery.expander.min.js' %}"></script>
<script src="{% static 'js/jquery.simplePagination.js' %}"></script>
<script type="text/javascript" src="{% static 'js/vendor/jquery.bootstrap-matrix-input.js' %}"></script>

<script src="{% static 'js/emif.documents.js' %}"></script>
<script src="{% static 'js/emif.jerboa.upload.js' %}"></script>
<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<script src="{% static 'js/vendor/jquery.ui.widget.js' %}"></script>
<!-- The Load Image plugin is included for the preview images and image resizing functionality -->
<script src="{% static 'js/vendor/load-image.min.js' %}"></script>
<!-- The Canvas to Blob plugin is included for image resizing functionality -->
<script src="{% static 'js/vendor/canvas-to-blob.min.js' %}"></script>
<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="{% static 'js/vendor/jquery.iframe-transport.js' %}"></script>
<!-- The basic File Upload plugin -->
<script src="{% static 'js/vendor/jquery.fileupload.js' %}"></script>
<!-- The File Upload processing plugin -->
<script src="{% static 'js/vendor/jquery.fileupload-process.js' %}"></script>
<!-- The File Upload image preview & resize plugin -->
<script src="{% static 'js/vendor/jquery.fileupload-image.js' %}"></script>
<!-- The File Upload audio preview plugin -->
<script src="{% static 'js/vendor/jquery.fileupload-audio.js' %}"></script>
<!-- The File Upload video preview plugin -->
<script src="{% static 'js/vendor/jquery.fileupload-video.js' %}"></script>
<!-- The File Upload validation plugin -->
<script src="{% static 'js/vendor/jquery.fileupload-validate.js' %}"></script>
<script src="{% static 'js/vendor/jquery.cookie.js' %}"></script>
<script src="{% static 'js/vendor/jquery.boolrelwidget.js' %}"></script>


<script src="{% static 'js/jquery.dyndropdown.js' %}"></script>
<!--[if gte IE 9]><!-->
<script src="{% static 'js/emif.charts.filters.js' %}"></script>
<script src="{% static 'js/emif.charts.draw.js' %}"></script>
<script src="{% static 'js/emif.populationcharacteristics.comments.js' %}"></script>
<script src="{% static 'js/vendor/ZeroClipboard.js' %}"></script>
<script src="{% static 'js/vendor/bootstrap-tagsinput.js' %}"></script>
<script src="{% static 'js/emif.public.js' %}"></script>
<script src="{% static 'js/jquery.dataTables.js' %}"></script>
<script src="{% static 'js/dataTables.tableTools.js' %}"></script>
<script src="{% static 'js/dataTables.bootstrap.js' %}"></script>
<script src="{% static 'js/dataTables.bootstrap.js' %}"></script>

<script type="text/javascript" src="{% static 'js/jquery.tabmanager.js' %}"></script>
<script type="text/javascript" src="{% static 'js/widgets/widget.plug_shell.js' %}"></script>
<script type="text/javascript" src="{% static 'questionset.js' %}"></script>
<script type="text/javascript" src="{% static 'js/vendor/jquery.errornavigator.js' %}"></script>
<script type="text/javascript" src="{% static 'js/jquery.simplePagination.js' %}"></script>
<script type="text/javascript" src="{% static 'js/fingerprint_edit.js' %}"></script>

{% endblock %}




{% block content %}

{% if qsets %}
<!-- population_char part2 -->
{% if config.population_characteristics and comm.show_popchar %}
<!--div class="tab-pane {%if activetab == 'pc'%}active{%endif%}" id="populationcharacteristics"-->
<div id="populationcharacteristics">
  {% include "population_characteristics.html" %}
</div>

{% endif %}

{% else %}
<div class="row">
    <div class="col-md-4">
        <div class="alert">
            <a class="close" data-dismiss="error">Ã—</a>
            <strong>Warning!</strong>
            You don't have results.
        </div>
    </div>
</div>

{% endif %}



{% if isAdvanced %}
<div id="bool_container"></div>
{% endif %}

{% endblock %}

{% block scriptextraincludes %}
<!-- Include the widget embedding script -->

<!--[if lte IE 8]>
<script src="{% static 'js/d3/r2d3.min.js' %}" charset="utf-8"></script>
<![endif]-->
<!--[if gte IE 9]><!-->
<script src="{% static 'js/d3/d3.v3.min.js' %}" charset="utf-8"></script>
<script src="{% static 'js/d3/d3.layout.cloud.js' %}"></script>
<script src="{% static 'js/c3.js' %}"></script>
<!--<![endif]-->
<script src="{% static 'js/database_info.js' %}"></script>
<script src="{% static 'js/emif.database.delete.js' %}"></script>

<!--[if gte IE 9]><!-->
<script src="{% static 'js/emif.populationcharacteristics.charts.js' %}"></script>
<script src="{% static 'js/emif.populationcharacteristics.js' %}"></script>
<!--<![endif]-->

<!--[if gte IE 9]><!-->
<script src="{% static 'js/emif.c3js.tabular.js' %}"></script>
<script src="{% static 'js/emif.charts.c3d3.js' %}"></script>
<script src="{% static 'js/emif.charts.d3.js' %}"></script>

<script src="{% static 'js/emif.charts.js' %}"></script>
<!--<![endif]-->
<script src="{% static 'js/emif.fingerprint.counter.js' %}"></script>
<!-- Fix later -->
<script src="{% static 'js/vendor/bootstrap-tooltip.js' %}"></script>
<script src="{% static 'js/vendor/bootstrap-popover.js' %}"></script>
<script src="{% static 'js/vendor/jquery.inputmask.bundle.js' %}" type="text/javascript"></script>
<script src="{% static 'js/fingerprint.js' %}"></script>

{% endblock %}

<script>
{% block scriptextra %}
var global_fingerprint_id = '{{fingerprint_id}}';
var global_public_key = '{{public_key.hash}}';
var global_is_authenticated = {% if request.user.is_authenticated %}true{% else %}false{% endif %};

{% if owner_fingerprint %}
var global_owner = true;
{% endif %}

{%if latest_pop %}
var global_revision = '{{latest_pop.revision}}';
{% endif %}

{% if comm %}
var community = '{{comm.slug}}';
{% endif %}


function load_questionnary(){
    console.log("Creating questionnary set containers (so they are in order)");
    pushQsets();

    //var threadpool = new TaskQueuer(20);
    //parts_missing = {{qsets|length}};

    var priority=1;
    {% for tuple, permissions in qsets %}
    {% if permissions.visibility == 0 or owner_fingerprint or request.user.is_superuser %}
    //        var thread = new Runnable(loadqspartsumm, priority++, {{tuple.1.sortid}}, '{{fingerprint_id}}');
    //        threadpool.run(thread);
    //        threads['qs_{{ tuple.1.sortid }}'] = thread;
    {% endif %}
    {% endfor %}

    console.log( "Loading questionnary by parts, we have {{qsets|length}} sets");

    {% for k, qs in qsets.ordered_items %}
    //var thread = new Runnable(loadqspartsumm, priority++, {{qs.sortid}}, '{{fingerprint_id}}');
    //threadpool.run(thread);
    //threads['qs_{{ qs.sortid }}'] = thread;
    {% endfor %}

    //  we add the triggers thread
    //threadpool.destroy(function(){
    //    $('#show_hide_button').fadeIn();
    //});
}

var db_name = '{{breadcrumb_name}}';

$(function(){
    var csrf_token = '{{ csrf_token }}';
    {% get_hit_count for fingerprint %}
    initDatabaseInfo('{{apiinfo|safe}}');
    {% if isAdvanced %}
    initAdvSearchPlugin('{{request.session.serialization_query}}', '{{request.session.query_type}}', '{{request.session.query_id}}');
    {% endif %}
    if('{{activetab}}' == 'pc'){
        $('.graphTypes:first').click();
    }
});

function pushQsets(){
    containers = []
    // We build the qs containers in memory and just do dom op, on the end, for speed
    // on ie joins are significantly faster than concatenation
    // tuple = k, qs

    {% for tuple, permissions in qsets %}
    {% if permissions.visibility == 0 or owner_fingerprint or request.user.is_superuser %}
    containers.push('<div class="'+
        '{% if not permissions.allow_exporting %}noexporting {% endif %}'+
        '{%if permissions.visibility == 1 %}{% if owner_fingerprint or request.user.is_superuser %} privategroup{% endif %}{% endif %} panel panel-default" id="dbaccordion{{forloop.counter}}">'
        +'<div class="panel-heading"><a style="display: inline-block; width: 90%;" class="accordion-toggle" data-toggle="collapse" data-parent="#dbaccordion{{forloop.counter}}" href="#collapse{{ tuple.0|removespaces|safe|clean }}">{{ tuple.0|removeh1 }} </a>'+
        '{% if permissions.visibility == 1 and owner_fingerprint %}<i class="tooltipit fa fa-eye-close" title="This questionset is private, only the data custodian can see it." ></i>{% endif %}'+
        '{% if not permissions.allow_exporting %}<img class="tooltipit" title="The data custodian doesn\'t allow this section to be exported." src="{% static 'img/noexport.png' %}"/>{% endif %}'+
        '<span class="accordion-icon">{% if tuple.1.highlights %}<img title="This section has search keywords" class="markered" src="{% static 'img/marker.png' %}" /> {% endif %}</span></div><div id="collapse{{ tuple.0|removespaces|safe|clean }}" class="panel-collapse collapse"><div id="qs_summ_{{ tuple.1.sortid }}" class="panel-body"><h4 class="pull-center loadingsection">Loading...</h4></div></div></div>');
    {% endif %}
    {% endfor %}
    $('#setsumm_container').append(containers.join(''));
}

$(function(){
    arr_len = {{plugins|length}};
    {% for version in plugins %}
    var conf_pos = {{version|plugin_sortid:comm}};
    {% if not version.is_remote %}
    sandbox('{{version.plugin.slug}}',
        function(callback){
            var confs, plugin;

            {{version.path|safe}}

            if(callback) callback(confs, plugin);
        }, conf_pos);
    {% else %}
    $.ajax({
        url: '{{version.path|safe}}',
        method: 'GET',
        crossDomain: true,
        contentType: 'application/x-www-form-urlencoded; charset=UTF-8'
    })
    .done(function(data){
        sandbox('{{version.plugin.slug}}', data, conf_pos);
    })
    .fail(function(data){
        console.log("We couldn't obtain the remote plugin from url: '{{version.path|safe}}'");
    });
    {%endif%}
    {% endfor %}
    {% if activetab %}
    setTimeout(function(){
        $('[href="#{{activetab}}"]').click();
    }, 1000);
    {% endif %}
});

var global_fingerprint_id = '{{fingerprint_id}}';
this_mode = QsType.VIEW;
active_qset = '{{questionset.sortid}}';
$('#li_workspace').addClass("active");


function generateStub(){
  var containers = [];
        // We build the qs containers in memory and just do dom op, on the end, for speed
        // on ie joins are significantly faster than concatenation
        {% for qs in questionset.questionnaire.questionsets %}
        containers.push('<div id="qs_{{ qs.sortid }}" class="{% if qs.sortid == questionset.sortid %} {% else %} hide {% endif %} questionset"><h4 class="loadingindicator pull-center">Loading...</h4></div>\n');
        {% endfor %}
        var sc = $('#set_container').append('<div class="nano"><div class="nano-content">'+containers.join('')+'</div></div>');
        sc.find('.nano').height(($(window).height() - sc.offset().top)-10);
    }

    $(function(){
        initQsEnv("{{fingerprint_id}}","{{q_id}}","{{questionset.sortid}}", QsType.VIEW);

  /*$('.percentagebar').scrollToFixed(
    {
      marginTop: 100,
      preFixed: function() { $(this).append('<div class="shadowappend"></div>'); },
      postFixed: function() { $(this).find('.shadowappend').remove(); },
  });*/
    {% if comm %}
    {% for version in plugins %}
    tm.addWidget('{{version.plugin.slug}}');
    {% endfor %}

    {% endif %}

    $('#hide_empty_').click(function(){
        console.log('HIDE EMPTY');
        console.log(active_qset);
        setupHideEmpties(active_qset, 'empty');
    });
    $('#hide_filled_').click(function(){
        console.log('HIDE_FILL');
        setupHideEmpties(active_qset, 'filled');
    });

});

//questionsets_handle(qs_0);
function initialCounterSetup(){
  {% for qs, answered, total_count, percentage, _, _, _, _ in questionsets %}
  questionSetsCounters["{{qs.sortid}}"] = { filledQuestions: {{answered}}, count: {{total_count}} };
  {% endfor %}
}

{% endblock %}

</script>
